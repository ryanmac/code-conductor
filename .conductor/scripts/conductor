#!/bin/bash
# The ONLY command AI agents need to know for Code Conductor projects

set -e

# Check prerequisites
if ! command -v gh >/dev/null 2>&1; then
    echo "âŒ GitHub CLI not found. Please install it first:"
    echo "   Visit: https://cli.github.com"
    exit 1
fi

if ! gh auth status >/dev/null 2>&1; then
    echo "âŒ GitHub CLI not authenticated"
    echo "   Run: gh auth login"
    exit 1
fi

if ! git rev-parse --git-dir >/dev/null 2>&1; then
    echo "âŒ Not in a git repository"
    exit 1
fi

# Ensure we're in the project root
if [ ! -f ".conductor/config.yaml" ]; then
    echo "âŒ Error: Not in a Code Conductor project directory"
    echo "   Please run from the project root where .conductor/ exists"
    exit 1
fi

# Store project root for reference
PROJECT_ROOT=$(pwd)
PROJECT_NAME=$(basename "$PROJECT_ROOT")

# Get command and role
COMMAND=${1:-start}
ROLE=${2:-dev}

# Normalize role names (case-insensitive with common aliases)
ROLE=$(echo "$ROLE" | tr '[:upper:]' '[:lower:]')
case "$ROLE" in
    frontend|front|fe) ROLE="frontend" ;;
    backend|back|be) ROLE="backend" ;;
    devops|ops|infra) ROLE="devops" ;;
    security|sec) ROLE="security" ;;
    ml|ml-engineer|ai) ROLE="ml-engineer" ;;
    ui|ux|design*) ROLE="ui-designer" ;;
    data|analytics) ROLE="data" ;;
    mobile|ios|android) ROLE="mobile" ;;
    qa|test*) ROLE="qa" ;;
    dev|developer|*) ROLE="dev" ;;  # Default fallback
esac

# Ensure state directory exists
mkdir -p .conductor

case "$COMMAND" in
    start|s)
        echo "ðŸŽ¼ Code Conductor - $PROJECT_NAME"
        echo "=================================="
        echo "Role: $ROLE"
        echo ""
        
        # Check for existing task
        if [ -f .conductor/.current-task ]; then
            CURRENT_TASK=$(cat .conductor/.current-task)
            echo "âš ï¸  You have an active task: #$CURRENT_TASK"
            echo "   Complete it first with: ./conductor complete"
            echo "   Or check status with: ./conductor status"
            exit 1
        fi
        
        # Get available tasks
        echo "ðŸ” Finding suitable tasks..."
        TASKS=$(gh issue list \
            --label "conductor:task" \
            --state open \
            --json number,title,labels,assignees \
            --jq '.[] | select(.assignees | length == 0)')
        
        if [ -z "$TASKS" ]; then
            echo ""
            echo "ðŸ“‹ No tasks found. Let me check if this is a new project..."
            
            # Check if this is first run (no existing tasks at all)
            ALL_TASKS=$(gh issue list --label "conductor:task" --state all --limit 1)
            if [ -z "$ALL_TASKS" ]; then
                echo ""
                echo "ðŸŽ‰ Welcome to Code Conductor! Creating starter tasks..."
                
                # Create demo tasks for new projects
                gh issue create \
                    --title "[INIT] Discover project documentation and create task map" \
                    --label "conductor:task,conductor:init,effort:medium,priority:high" \
                    --body "## AI Agent Task: Documentation Discovery

This is a special task for AI agents to explore and map this project's documentation.

### Instructions
1. Explore all documentation files (README, docs/, wikis, etc.)
2. Identify the project's purpose, architecture, and components
3. Create a comprehensive task map for development

### Success Criteria
- [ ] Created .conductor/documentation-map.yaml
- [ ] Identified all major components
- [ ] Proposed initial development tasks
- [ ] Documented any unclear areas

### Deliverable
Create \`.conductor/documentation-map.yaml\` with discovered information." \
                    >/dev/null
                
                gh issue create \
                    --title "Set up comprehensive test suite" \
                    --label "conductor:task,effort:medium,priority:high,skill:dev" \
                    --body "Create or enhance the project's test coverage with appropriate testing framework" \
                    >/dev/null
                    
                gh issue create \
                    --title "Configure CI/CD pipeline" \
                    --label "conductor:task,effort:medium,priority:medium,skill:devops" \
                    --body "Set up GitHub Actions for automated testing, linting, and deployment" \
                    >/dev/null
                
                echo "âœ“ Created 3 starter tasks"
                echo ""
                echo "ðŸš€ Try again: ./conductor start $ROLE"
                exit 0
            else
                echo "âŒ No unassigned tasks available"
                echo ""
                echo "ðŸ’¡ Options:"
                echo "   1. Create a new task as a GitHub issue with label 'conductor:task'"
                echo "   2. Wait for tasks to be unassigned"
                echo "   3. Check: gh issue list --label conductor:task"
                exit 1
            fi
        fi
        
        # Claim a task using the Python script
        echo ""
        CLAIM_OUTPUT=$(python .conductor/scripts/task-claim.py --role "$ROLE" 2>&1)
        CLAIM_STATUS=$?
        
        if [ $CLAIM_STATUS -ne 0 ]; then
            echo "âŒ Failed to claim task:"
            echo "$CLAIM_OUTPUT"
            exit 1
        fi
        
        # Extract task ID from output
        TASK_ID=$(echo "$CLAIM_OUTPUT" | grep -o "Claimed task #[0-9]*" | grep -o "[0-9]*")
        
        if [ -z "$TASK_ID" ]; then
            echo "âŒ Could not determine task ID"
            exit 1
        fi
        
        # Save current task
        echo "$TASK_ID" > .conductor/.current-task
        
        # Create worktree
        BRANCH_NAME="conductor/task-$TASK_ID"
        WORKTREE_PATH="worktrees/agent-$ROLE-task-$TASK_ID"
        
        echo ""
        echo "ðŸ“ Setting up worktree..."
        
        # Ensure we're on a branch (not detached HEAD)
        if ! git symbolic-ref HEAD >/dev/null 2>&1; then
            git checkout -b temp-branch >/dev/null 2>&1
        fi
        
        # Create worktree
        git worktree add -b "$BRANCH_NAME" "$WORKTREE_PATH" >/dev/null 2>&1 || {
            # If branch exists, use it
            git worktree add "$WORKTREE_PATH" "$BRANCH_NAME" >/dev/null 2>&1
        }
        
        # Save worktree path
        echo "$WORKTREE_PATH" > .conductor/.current-worktree
        
        # Get task details for context file
        TASK_JSON=$(gh issue view "$TASK_ID" --json title,body,labels)
        TASK_TITLE=$(echo "$TASK_JSON" | jq -r '.title')
        TASK_BODY=$(echo "$TASK_JSON" | jq -r '.body')
        
        # Create context file
        cat > "$WORKTREE_PATH/.conductor-context" << EOF
# Task Context for AI Agent

## Task #$TASK_ID: $TASK_TITLE

### Description
$TASK_BODY

### Your Role: $ROLE

### Working Directory
$WORKTREE_PATH

### Next Steps
1. Review the task requirements above
2. Make necessary changes in this worktree
3. Commit your changes
4. Run: ./conductor complete

### Available Commands
- ./conductor status - Check current progress
- ./conductor complete - Finish task and create PR
EOF
        
        echo "âœ… Ready to work on task #$TASK_ID!"
        echo ""
        echo "ðŸ“‹ Task: $TASK_TITLE"
        echo "ðŸ“ Worktree: $WORKTREE_PATH"
        echo ""
        echo "ðŸš€ To start working:"
        echo "   cd $WORKTREE_PATH"
        echo "   cat .conductor-context  # Review task details"
        echo ""
        echo "   When done: ./conductor complete"
        ;;
        
    complete|c)
        if [ ! -f .conductor/.current-task ]; then
            echo "âŒ No active task. Run: ./conductor start"
            exit 1
        fi
        
        TASK_ID=$(cat .conductor/.current-task)
        WORKTREE=$(cat .conductor/.current-worktree)
        
        echo "âœ… Completing task #$TASK_ID"
        echo ""
        
        # Get task title for commit message
        TASK_TITLE=$(gh issue view "$TASK_ID" --json title -q '.title')
        
        # Auto-commit if changes exist
        cd "$WORKTREE"
        if ! git diff --quiet || ! git diff --cached --quiet; then
            echo "ðŸ“ Committing changes..."
            git add -A
            git commit -m "Complete task #$TASK_ID: $TASK_TITLE

Implements the requirements specified in issue #$TASK_ID.

Co-Authored-By: AI Agent <conductor@ai>"
        fi
        
        # Check if we have commits to push
        if [ -z "$(git log origin/main..HEAD 2>/dev/null)" ]; then
            echo "âŒ No commits to push. Make some changes first!"
            exit 1
        fi
        
        # Push changes
        echo "ðŸ“¤ Pushing changes..."
        git push origin HEAD
        
        # Create PR
        echo "ðŸ”„ Creating pull request..."
        PR_URL=$(gh pr create \
            --title "Complete: $TASK_TITLE" \
            --body "## Summary
Completes task #$TASK_ID

## Changes
$(git log origin/main..HEAD --oneline)

## Testing
- [ ] Tests pass
- [ ] Code follows project standards

Closes #$TASK_ID" \
            --base main)
        
        echo ""
        echo "âœ… Task completed!"
        echo "ðŸ“Ž PR: $PR_URL"
        
        # Update issue
        gh issue comment "$TASK_ID" --body "Pull request created: $PR_URL"
        
        # Return to project root and cleanup
        cd "$PROJECT_ROOT"
        rm -f .conductor/.current-task .conductor/.current-worktree
        
        echo ""
        echo "ðŸŽ‰ Great work! Ready for next task:"
        echo "   ./conductor start $ROLE"
        ;;
        
    status)
        echo "ðŸ“Š Code Conductor Status"
        echo "========================"
        echo "Project: $PROJECT_NAME"
        echo ""
        
        if [ -f .conductor/.current-task ]; then
            TASK_ID=$(cat .conductor/.current-task)
            WORKTREE=$(cat .conductor/.current-worktree 2>/dev/null || echo "unknown")
            
            TASK_INFO=$(gh issue view "$TASK_ID" --json title,state,labels)
            TASK_TITLE=$(echo "$TASK_INFO" | jq -r '.title')
            TASK_STATE=$(echo "$TASK_INFO" | jq -r '.state')
            
            echo "Current Task:"
            echo "  ðŸ“Œ #$TASK_ID: $TASK_TITLE"
            echo "  ðŸ“ Worktree: $WORKTREE"
            echo "  ðŸ·ï¸  State: $TASK_STATE"
            echo ""
            echo "Commands:"
            echo "  ./conductor complete - Finish this task"
            echo "  cd $WORKTREE - Go to work directory"
        else
            echo "No active task."
            echo ""
            echo "Available tasks:"
            gh issue list \
                --label "conductor:task" \
                --state open \
                --json number,title,assignees \
                --jq '.[] | select(.assignees | length == 0) | "  #\(.number): \(.title)"' \
                | head -5
            echo ""
            echo "Start with: ./conductor start $ROLE"
        fi
        ;;
        
    tasks|list)
        echo "ðŸ“‹ Available Tasks"
        echo "=================="
        echo ""
        gh issue list \
            --label "conductor:task" \
            --state open \
            --json number,title,labels,assignees \
            --jq '.[] | select(.assignees | length == 0) | "
#\(.number): \(.title)
  Labels: \(.labels | map(.name) | join(", "))
"'
        ;;
        
    progress|p)
        if [ ! -f .conductor/.current-task ]; then
            echo "âŒ No active task. Run: ./conductor start"
            exit 1
        fi
        
        TASK_ID=$(cat .conductor/.current-task)
        WORKTREE=$(cat .conductor/.current-worktree 2>/dev/null || echo "unknown")
        
        # Get task info
        TASK_INFO=$(gh issue view "$TASK_ID" --json title,number)
        TASK_TITLE=$(echo "$TASK_INFO" | jq -r '.title')
        
        echo "ðŸ“ Progress Update for Task #$TASK_ID"
        echo "=================================="
        echo "Task: $TASK_TITLE"
        echo ""
        echo "Enter your progress update (Markdown supported):"
        echo "Press Ctrl+D when finished"
        echo ""
        
        # Read multiline input
        PROGRESS_UPDATE=$(cat)
        
        if [ -z "$PROGRESS_UPDATE" ]; then
            echo "âŒ No update provided. Cancelled."
            exit 1
        fi
        
        # Post comment to GitHub issue
        COMMENT_BODY="### ðŸ“Š Progress Update

$PROGRESS_UPDATE

---
*Updated by AI Agent (Role: ${ROLE}) at $(date '+%Y-%m-%d %H:%M:%S')*
*Worktree: \`$WORKTREE\`*"
        
        echo ""
        echo "ðŸ“¤ Posting update to GitHub..."
        
        gh issue comment "$TASK_ID" --body "$COMMENT_BODY"
        
        echo "âœ… Progress update posted!"
        echo ""
        echo "ðŸ’¡ Recent updates:"
        gh issue view "$TASK_ID" --comments --json comments \
            --jq '.comments[-3:] | .[] | "  - \(.author.login) (\(.createdAt | split("T")[0])): \(.body | split("\n")[0] | .[0:60])..."' 2>/dev/null || echo "  (Unable to fetch recent comments)"
        ;;
        
    recover|debug|fix)
        echo "ðŸ”§ Code Conductor Recovery Tool"
        echo "==============================="
        echo ""
        
        # Check 1: Git repository
        echo "1ï¸âƒ£ Checking git repository..."
        if ! git rev-parse --git-dir >/dev/null 2>&1; then
            echo "   âŒ Not in a git repository!"
            echo "   Fix: Run conductor commands from project root"
            exit 1
        fi
        echo "   âœ… Git repository detected"
        echo ""
        
        # Check 2: GitHub CLI authentication
        echo "2ï¸âƒ£ Checking GitHub CLI..."
        if ! gh auth status >/dev/null 2>&1; then
            echo "   âŒ GitHub CLI not authenticated!"
            echo "   Fix: Run 'gh auth login'"
            exit 1
        fi
        echo "   âœ… GitHub CLI authenticated"
        echo ""
        
        # Check 3: Conductor configuration
        echo "3ï¸âƒ£ Checking conductor configuration..."
        if [ ! -f ".conductor/config.yaml" ]; then
            echo "   âŒ Conductor not configured!"
            echo "   Fix: Run 'python setup.py' first"
            exit 1
        fi
        echo "   âœ… Conductor configured"
        echo ""
        
        # Check 4: Current task state
        echo "4ï¸âƒ£ Checking task state..."
        if [ -f .conductor/.current-task ]; then
            TASK_ID=$(cat .conductor/.current-task)
            WORKTREE=$(cat .conductor/.current-worktree 2>/dev/null || echo "none")
            echo "   ðŸ“Œ Found active task: #$TASK_ID"
            echo "   ðŸ“ Worktree: $WORKTREE"
            
            # Check if worktree still exists
            if [ "$WORKTREE" != "none" ] && [ ! -d "$WORKTREE" ]; then
                echo "   âš ï¸  Worktree missing! State is inconsistent."
                echo ""
                echo "   Options:"
                echo "   1) Clear state and start fresh"
                echo "   2) Try to recover worktree"
                echo "   3) Cancel"
                read -p "   Choice [1-3]: " choice
                
                case $choice in
                    1)
                        rm -f .conductor/.current-task .conductor/.current-worktree
                        echo "   âœ… State cleared. Run './conductor start' to begin fresh."
                        ;;
                    2)
                        echo "   Attempting to recreate worktree..."
                        BRANCH_NAME="conductor/task-$TASK_ID"
                        git worktree add -b "$BRANCH_NAME" "$WORKTREE" >/dev/null 2>&1 || \
                            git worktree add "$WORKTREE" "$BRANCH_NAME" >/dev/null 2>&1 || \
                            echo "   âŒ Could not recover. Use option 1 to clear state."
                        ;;
                    *)
                        echo "   Cancelled."
                        ;;
                esac
            else
                echo "   âœ… Task state appears valid"
            fi
        else
            echo "   âœ… No active task (clean state)"
        fi
        echo ""
        
        # Check 5: Worktrees
        echo "5ï¸âƒ£ Checking worktrees..."
        if [ -d worktrees ]; then
            WORKTREE_COUNT=$(ls -1 worktrees 2>/dev/null | wc -l | tr -d ' ')
            if [ "$WORKTREE_COUNT" -gt 0 ]; then
                echo "   ðŸ“ Found $WORKTREE_COUNT worktree(s):"
                for wt in worktrees/*; do
                    if [ -d "$wt" ]; then
                        echo -n "      - $(basename $wt)"
                        # Check for uncommitted changes
                        if cd "$wt" 2>/dev/null && ! git diff --quiet; then
                            echo " âš ï¸  (has uncommitted changes)"
                            cd - >/dev/null
                        else
                            echo " âœ…"
                            cd - >/dev/null 2>&1
                        fi
                    fi
                done
                
                echo ""
                echo "   Clean up old worktrees?"
                echo "   1) Yes - Remove all worktrees older than 7 days"
                echo "   2) No - Keep all worktrees"
                read -p "   Choice [1-2]: " cleanup_choice
                
                if [ "$cleanup_choice" = "1" ]; then
                    echo "   Cleaning old worktrees..."
                    find worktrees -type d -mtime +7 -maxdepth 1 -exec rm -rf {} \; 2>/dev/null
                    echo "   âœ… Cleanup complete"
                fi
            else
                echo "   âœ… No worktrees found"
            fi
        else
            echo "   âœ… No worktrees directory"
        fi
        echo ""
        
        # Summary
        echo "ðŸ“Š Recovery Summary"
        echo "=================="
        echo "All checks complete. Your conductor setup is:"
        if [ -f .conductor/.current-task ]; then
            echo "âœ… Ready to continue with task #$TASK_ID"
            echo ""
            echo "Next steps:"
            echo "  ./conductor status    - See current task"
            echo "  ./conductor progress  - Update task progress"
            echo "  ./conductor complete  - Finish current task"
        else
            echo "âœ… Ready for new work"
            echo ""
            echo "Next step:"
            echo "  ./conductor start    - Begin a new task"
        fi
        ;;
        
    help|*)
        echo "ðŸŽ¼ Code Conductor - AI Agent Command"
        echo "===================================="
        echo ""
        echo "Usage: ./conductor [command] [role]"
        echo ""
        echo "Commands:"
        echo "  start [role]    Begin work on a new task (default: dev)"
        echo "  complete        Finish current task and create PR"
        echo "  status          Show current task and project info"
        echo "  progress        Update progress on current task (alias: p)"
        echo "  tasks           List available tasks"
        echo "  recover         Diagnose and fix common issues (aliases: debug, fix)"
        echo "  help            Show this help message"
        echo ""
        echo "Roles:"
        echo "  dev       General development (default)"
        echo "  frontend  UI/React/Vue work (aliases: fe, front)"
        echo "  backend   API/server work (aliases: be, back)"
        echo "  devops    Infrastructure/CI (aliases: ops)"
        echo "  security  Security tasks (alias: sec)"
        echo "  mobile    iOS/Android development"
        echo "  ml        Machine learning (aliases: ai, ml-engineer)"
        echo "  data      Data engineering/analytics"
        echo ""
        echo "Quick Start:"
        echo "  ./conductor start         # Start as dev"
        echo "  ./conductor start fe      # Start as frontend"
        echo "  ./conductor progress      # Update task progress"
        echo "  ./conductor complete      # Finish current task"
        echo "  ./conductor recover       # Fix issues if stuck"
        ;;
esac